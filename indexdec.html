<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>IDX Bandar Analyzer (Trend Aware)</title>

<style>
body { font-family: Arial, sans-serif; padding:20px; }
table { border-collapse: collapse; width:100%; font-size:12.5px; }
th,td { border:1px solid #ccc; padding:6px; text-align:right; }
th { background:#f0f0f0; }
td.left { text-align:left; }

.DOWN { background:#ffe0cc; }
.UP { background:#d7ecff; }
.ACC { background:#c8facc; }
.DIST { background:#ffd6d6; }
.FAKE { background:#fff3b0; }
.PANIC { background:#ffb3b3; }
</style>
</head>
<body>

<h3>IDX Bandar Analyzer — Trend Aware</h3>
<small>
✔ Trend multi-hari sebagai rule utama<br>
✔ Weekend & libur aman<br>
✔ Cocok untuk saham Indonesia
</small>

<table id="tbl">
<thead>
<tr>
<th>Saham</th>
<th>Close</th>
<th>RelVol</th>
<th>RelFreq</th>
<th>RelValue</th>
<th>RelAvgTrade</th>
<th>Broker Net (Lot)</th>
<th>Kesimpulan</th>
<th>Alasan</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const BASE_STOCKSUMMARY = "https://raw.githubusercontent.com/paulgithubcode/sind/main/stocksummary/";
const BASE_BROKSUM = "https://raw.githubusercontent.com/paulgithubcode/sind/main/broksum/";

const START_DATE = new Date("2026-01-06");
const MAX_AVG = 20;

/* ===== UTIL ===== */
function dstr(d){ return d.toISOString().slice(0,10); }
function fmt(n){ return Number(n||0).toLocaleString("id-ID"); }

async function fetchSafe(url){
  try{
    const r = await fetch(url);
    if(!r.ok) return null;
    return await r.json();
  }catch{ return null; }
}

/* ===== HITUNG TREND MULTI-HARI ===== */
function trendScore(data, n=5){
  if(data.length < n+1) return 0;
  let down=0, up=0;
  for(let i=data.length-n;i<data.length;i++){
    if(data[i].close < data[i-1].close) down++;
    else if(data[i].close > data[i-1].close) up++;
  }
  return down - up; // >=3 = downtrend valid
}

/* ===== MAIN ===== */
async function run(){
  const today = new Date();
  const stockMap = {};
  const brokMap = {};
  const validDates = [];

  /* === LOAD STOCK SUMMARY === */
  for(let d=new Date(START_DATE); d<=today; d.setDate(d.getDate()+1)){
    const ds = dstr(new Date(d));
    const js = await fetchSafe(`${BASE_STOCKSUMMARY}GetStockSummary_${ds}.json`);
    if(!js) continue;

    validDates.push(ds);

    js.data.forEach(s=>{
      if(!stockMap[s.StockCode]) stockMap[s.StockCode]=[];
      stockMap[s.StockCode].push({
        close:s.Close,
        volume:s.Volume,
        value:s.Value,
        freq:s.Frequency
      });
    });
  }

  /* === LOAD BROKER SUMMARY MULTI-HARI === */
  for(const ds of validDates){
    const js = await fetchSafe(`${BASE_BROKSUM}BrokSum_${ds}.json`);
    if(!js?.tickers) continue;

    Object.entries(js.tickers).forEach(([code,data])=>{
      if(!brokMap[code]) brokMap[code]=0;
      data.netbuy.forEach(b=> brokMap[code]+=parseFloat(b.nlot.replace(/,/g,"")));
      data.netsell.forEach(b=> brokMap[code]-=parseFloat(b.nlot.replace(/,/g,"")));
    });
  }

  const tbody = document.querySelector("#tbl tbody");

  Object.keys(stockMap).forEach(code=>{
    const rows = stockMap[code];
    if(rows.length < 6) return;

    const N = Math.min(MAX_AVG, rows.length);
    const recent = rows.slice(-N);
    const cur = recent.at(-1);

    const avgVol = recent.reduce((a,b)=>a+b.volume,0)/N;
    const avgFreq = recent.reduce((a,b)=>a+b.freq,0)/N;
    const avgVal = recent.reduce((a,b)=>a+b.value,0)/N;
    const avgAT = recent.reduce((a,b)=>a+(b.volume/b.freq),0)/N;

    const relVol = cur.volume/avgVol;
    const relFreq = cur.freq/avgFreq;
    const relVal = cur.value/avgVal;
    const relAT = (cur.volume/cur.freq)/avgAT;

    const brokerNet = brokMap[code] || 0;
    const tScore = trendScore(recent,5);

    let label="Netral", cls="", reason=[];

    /* ===== KEPUTUSAN (URUTAN KRITIS) ===== */

    /* 1️⃣ DOWNTREND VALID (PALING ATAS) */
    if(tScore >= 3){
      label="Downtrend Valid";
      cls="DOWN";
      reason.push("Lower high & lower low (multi-hari)");
      reason.push("Tekanan jual konsisten");
    }

    /* 2️⃣ PANIC SELL */
    if(relVol > 2 && brokerNet < 0){
      label="Panic Sell";
      cls="PANIC";
      reason=["Volume ekstrem","Broker jual agresif"];
    }

    /* 3️⃣ BANDAR SERAP */
    else if(relVol>1.3 && relAT>1.3 && relVal>relVol && brokerNet>0){
      label="Bandar Serap";
      cls="ACC";
      reason=["Uang masuk dominan","Ukuran transaksi membesar","Broker net buy"];
    }

    /* 4️⃣ UPTREND VALID */
    else if(tScore <= -3 && relVal>1.2){
      label="Uptrend Valid";
      cls="UP";
      reason=["Higher high & higher low","Uang mendukung"];
    }

    /* 5️⃣ DISTRIBUSI */
    else if(relFreq>1.5 && relAT<0.8 && brokerNet<0){
      label="Distribusi Bertahap";
      cls="DIST";
      reason=["Ramai tapi lot mengecil","Broker jual"];
    }

    /* 6️⃣ FAKE MOVE */
    else if(relFreq>1.5 && relAT<0.7){
      label="Naik Palsu";
      cls="FAKE";
      reason=["Ramai tapi uang kecil"];
    }

    const tr=document.createElement("tr");
    tr.className=cls;
    tr.innerHTML=`
      <td class="left"><b>${code}</b></td>
      <td>${fmt(cur.close)}</td>
      <td>${relVol.toFixed(2)}</td>
      <td>${relFreq.toFixed(2)}</td>
      <td>${relVal.toFixed(2)}</td>
      <td>${relAT.toFixed(2)}</td>
      <td>${fmt(brokerNet)}</td>
      <td class="left"><b>${label}</b></td>
      <td class="left"><small>${reason.join("; ")}</small></td>
    `;
    tbody.appendChild(tr);
  });
}

run();
</script>

</body>
</html>

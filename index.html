<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>IDX Stock Summary + Sector (DataTables)</title>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h3 { margin: 20px 0 10px; }
    label { font-weight: bold; }
    input[type="date"] { padding: 4px; margin-left: 8px; }
    table.dataTable td { font-size: 13px; }
    td.dt-right { text-align: right; }
  </style>
</head>
<body>

<h3>IDX Stock Summary by Sector</h3>

<label>
  Pilih Tanggal:
  <input type="date" id="datePicker">
</label>

<br><br>

<table id="stockTable" class="display" style="width:100%">
  <thead>
    <tr>
      <th>Kode</th>
      <th>Nama Saham</th>
      <th>Konglomerat</th>
      <th>Sektor</th>
      <th>Close</th>
      <th>Volume</th>
      <th>Value (in Rupiah)</th>
      <th>Δ Value</th>
      <th>Weight For Index</th>
      <th>Market Cap</th>
      <th>Change</th>
      <th>Change %</th>
    </tr>
  </thead>
</table>

<h3>Summary Per Konglomerat</h3>
<table id="summaryKonglomeratTable" class="display" style="width:75%">
  <thead>
    <tr>
      <th>Konglomerat</th>
      <th>Rata-rata %Change</th>
      <th>Total Value (Rp)</th>
      <th>Total Δ Value (Rp)</th>
    </tr>
  </thead>
</table>

<h3>Summary Per Sektor</h3>
<table id="summarySectorTable" class="display" style="width:75%">
  <thead>
    <tr>
      <th>Sektor</th>
      <th>Rata-rata %Change</th>
      <th>Total Value (Rp)</th>
      <th>Total Δ Value (Rp)</th>
    </tr>
  </thead>
</table>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

<script>
// ================= KONFIG =================
const BASE_STOCKSUMMARY = "https://raw.githubusercontent.com/paulgithubcode/sind/main/stocksummary/";
const BASE_SECTOR = "https://raw.githubusercontent.com/paulgithubcode/sind/main/sector/";

// ================= KONGLOMERAT MAP =================
const konglomeratMap = {
  BREN:"Grup Prajogo Pangestu",TPIA:"Grup Prajogo Pangestu",BRPT:"Grup Prajogo Pangestu",
  CDIA:"Grup Prajogo Pangestu",CUAN:"Grup Prajogo Pangestu",PTRO:"Grup Prajogo Pangestu",
  BRMS:"Grup Bakrie",BUMI:"Grup Bakrie",ENRG:"Grup Bakrie",DEWA:"Grup Bakrie",
  VKTR:"Grup Bakrie",BNBR:"Grup Bakrie",
  MBMA:"Grup Boy Thohir",AADI:"Grup Boy Thohir",EMAS:"Grup Boy Thohir",
  MDKA:"Grup Boy Thohir",ADRO:"Grup Boy Thohir",
  DCII:"Grup Salim",DNET:"Grup Salim",ICBP:"Grup Salim",INDF:"Grup Salim",LSIP:"Grup Salim",
  DSSA:"Grup Sinarmas",SMMA:"Grup Sinarmas",GEMS:"Grup Sinarmas",EXCL:"Grup Sinarmas",SMAR:"Grup Sinarmas",
  PGUN:"Grup Haji Isam",JARR:"Grup Haji Isam",TEBE:"Grup Haji Isam",FAST:"Grup Haji Isam",
  RATU:"Grup Happy Hapsoro",RAJA:"Grup Happy Hapsoro",BUVA:"Grup Happy Hapsoro",
  MINA:"Grup Happy Hapsoro",SINI:"Grup Happy Hapsoro",
  EMTK:"Grup EMTEK",BBHI:"Grup EMTEK",SCMA:"Grup EMTEK",
  BUKA:"Grup EMTEK",SAME:"Grup EMTEK",SUPA:"Grup EMTEK",
  TAPG:"Grup Triputra",DSNG:"Grup Triputra",ESSA:"Grup Triputra",
  DRMA:"Grup Triputra",ASSA:"Grup Triputra",
  MLPT:"Grup Lippo",SILO:"Grup Lippo",LPKR:"Grup Lippo",MLPL:"Grup Lippo",LPPF:"Grup Lippo",
  PANI:"Grup Agung Sedayu (Aguan)",CBDK:"Grup Agung Sedayu (Aguan)",
  ERA:"Grup Agung Sedayu (Aguan)",INPC:"Grup Agung Sedayu (Aguan)",JIHD:"Grup Agung Sedayu (Aguan)",
  HUMI:"Grup Humpuss/Tommy Soeharto",GTSI:"Grup Humpuss/Tommy Soeharto",GOLF:"Grup Humpuss/Tommy Soeharto",
  WIFI:"Hashim Djojohadikusumo",COIN:"Hashim Djojohadikusumo",TRIN:"Hashim Djojohadikusumo",
  IRSX:"Hashim Djojohadikusumo",PADA:"Hashim Djojohadikusumo",INET:"Hashim Djojohadikusumo",
  TRUE:"Hashim Djojohadikusumo",KETR:"Hashim Djojohadikusumo",DOOH:"Hashim Djojohadikusumo",
  CLEO:"Hermanto Tanoko",RISE:"Hermanto Tanoko",CAKK:"Hermanto Tanoko",ZONE:"Hermanto Tanoko",
  DEPO:"Hermanto Tanoko",AVIA:"Hermanto Tanoko",PEVE:"Hermanto Tanoko",BLES:"Hermanto Tanoko",MERI:"Hermanto Tanoko",
};

// ================= UTIL =================
function todayStr(){ return new Date().toISOString().split("T")[0]; }
function prevDateStr(date){ const d=new Date(date); d.setDate(d.getDate()-1); return d.toISOString().split("T")[0]; }
function apiByDate(date){ return `${BASE_STOCKSUMMARY}GetStockSummary_${date}.json`; }

// ================= TABLES =================
let stockTable, summaryKonglomeratTable, summarySectorTable;

// ================= LOAD DATA =================
async function loadData(date){
  try{
    // Hari ini
    const res = await fetch(apiByDate(date));
    if(!res.ok) throw new Error("Data hari ini tidak tersedia");
    const todayJson = await res.json();

    // Hari -1
    let prevValueMap = {};
    try{
      const resPrev = await fetch(apiByDate(prevDateStr(date)));
      if(resPrev.ok){
        const prevJson = await resPrev.json();
        prevJson.data.forEach(r=>{ prevValueMap[r.StockCode] = r.Value; });
      }
    }catch(e){}

    // Sektor
    const sectorMap = {};
    const sectorFiles = [
      "Healthcare.json","Basic_Material.json","Financials.json",
      "Transportation_&_Logistic.json","Technology.json",
      "Consumer_Non-Cyclicals.json","Industrials.json","Energy.json",
      "Consumer_Cyclicals.json","Infrastructures.json",
      "Properties_&_Real_Estate.json"
    ];
    for(const f of sectorFiles){
      const r = await fetch(BASE_SECTOR + f);
      if(!r.ok) continue;
      const j = await r.json();
      j.data.forEach(x=>sectorMap[x.Code]=f.replace(".json",""));
    }

    // Merge data
    const data = todayJson.data.map(r=>{
      const prevVal = prevValueMap[r.StockCode] || 0;
      return {
        code:r.StockCode,
        name:r.StockName,
        kong:konglomeratMap[r.StockCode] || "-",
        sector:sectorMap[r.StockCode] || "-",
        close:r.Close,
        volume:r.Volume,
        valueRupiah:r.Value,
        deltaValue:r.Value-prevVal,
        weight:r.WeightForIndex,
        marketCap:r.Close*r.ListedShares,
        change:r.Change,
        changePct:r.Previous?((r.Close-r.Previous)/r.Previous)*100:0
      };
    });

    renderTables(data);

  }catch(e){ alert(e.message); console.error(e);}
}

// ================= RENDER =================
function renderTables(data){
  if(stockTable) stockTable.destroy();
  if(summaryKonglomeratTable) summaryKonglomeratTable.destroy();
  if(summarySectorTable) summarySectorTable.destroy();

  // Stock Table
  stockTable = $('#stockTable').DataTable({
    data,
    paging:false,
    order:[[11,'desc']],
    columns:[
      {data:'code'},
      {data:'name'},
      {data:'kong'},
      {data:'sector'},
      {data:'close',className:'dt-right',render:$.fn.dataTable.render.number('.',',',0)},
      {data:'volume',className:'dt-right',render:$.fn.dataTable.render.number('.',',',0)},
      {data:'valueRupiah',className:'dt-right',render:$.fn.dataTable.render.number('.',',',0)},
      {data:'deltaValue',className:'dt-right',render:d=>`<span style="color:${d>=0?'green':'red'}">${$.fn.dataTable.render.number('.',',',0).display(d)}</span>`},
      {data:'weight',className:'dt-right'},
      {data:'marketCap',className:'dt-right',render:$.fn.dataTable.render.number('.',',',0)},
      {data:'change',className:'dt-right'},
      {data:'changePct',className:'dt-right',render:d=>d.toFixed(2)+'%'}
    ]
  });

  // Summary Konglomerat
  const sumK = {};
  data.forEach(r=>{
    if(!sumK[r.kong]) sumK[r.kong]={chg:0,val:0,delta:0,c:0};
    sumK[r.kong].chg+=r.changePct;
    sumK[r.kong].val+=r.valueRupiah;
    sumK[r.kong].delta+=r.deltaValue;
    sumK[r.kong].c++;
  });
  summaryKonglomeratTable = $('#summaryKonglomeratTable').DataTable({
    data:Object.keys(sumK).map(k=>({
      kong:k,
      avgChange:sumK[k].chg/sumK[k].c,
      totalValue:sumK[k].val,
      totalDelta:sumK[k].delta
    })),
    paging:false,
    searching:false,
    order:[[1,'desc']],
    columns:[
      {data:'kong'},
      {data:'avgChange',className:'dt-right',render:d=>d.toFixed(2)+'%'},
      {data:'totalValue',className:'dt-right',render:$.fn.dataTable.render.number('.',',',0)},
      {data:'totalDelta',className:'dt-right',render:d=>`<span style="color:${d>=0?'green':'red'}">${$.fn.dataTable.render.number('.',',',0).display(d)}</span>`}
    ]
  });

  // Summary Sektor
  const sumS = {};
  data.forEach(r=>{
    if(!sumS[r.sector]) sumS[r.sector]={chg:0,val:0,delta:0,c:0};
    sumS[r.sector].chg+=r.changePct;
    sumS[r.sector].val+=r.valueRupiah;
    sumS[r.sector].delta+=r.deltaValue;
    sumS[r.sector].c++;
  });
  summarySectorTable = $('#summarySectorTable').DataTable({
    data:Object.keys(sumS).map(s=>({
      sector:s,
      avgChange:sumS[s].chg/sumS[s].c,
      totalValue:sumS[s].val,
      totalDelta:sumS[s].delta
    })),
    paging:false,
    searching:false,
    order:[[1,'desc']],
    columns:[
      {data:'sector'},
      {data:'avgChange',className:'dt-right',render:d=>d.toFixed(2)+'%'},
      {data:'totalValue',className:'dt-right',render:$.fn.dataTable.render.number('.',',',0)},
      {data:'totalDelta',className:'dt-right',render:d=>`<span style="color:${d>=0?'green':'red'}">${$.fn.dataTable.render.number('.',',',0).display(d)}</span>`}
    ]
  });
}

// ================= INIT =================
const datePicker = document.getElementById("datePicker");
datePicker.value = todayStr();
datePicker.addEventListener("change",()=>loadData(datePicker.value));
loadData(datePicker.value);
</script>

</body>
</html>

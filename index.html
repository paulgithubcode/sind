<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>IDX Stock Summary + Sector (DataTables + Δ Value)</title>

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h3 { margin: 20px 0 10px; }
    label { font-weight: bold; }
    input[type="date"] { padding: 4px; margin-left: 8px; }
    table.dataTable td { font-size: 13px; }
    td.dt-right { text-align: right; }
    .delta-positive { color: green; font-weight: bold; }
    .delta-negative { color: red; font-weight: bold; }
    .delta-zero { color: gray; }
  </style>
</head>
<body>

<h3>IDX Stock Summary by Sector</h3>

<label>
  Pilih Tanggal:
  <input type="date" id="datePicker">
</label>

<br><br>

<table id="stockTable" class="display" style="width:100%">
<thead>
  <tr>
	  <th>No</th>
	  <th>Kode</th>
	  <th>Nama</th>
	  <th>Konglomerat</th>
	  <th>Sektor</th>
	  <th>Close</th>
	  <th>Volume</th>
	  <th>Δ Volume</th>
	  <th>Δ % Volume</th>
	  <th>Frekuensi</th>
	  <th>Δ Frek</th>
	  <th>Δ % Frek</th>
	  <th>Value</th>
	  <th>Δ Value</th>
	  <th>Δ % Value</th>
	  <th>Weight For Index</th>
	  <th>Market Cap</th>
	  <th>Change</th>
	  <th>Change %</th>
	  <th>Keputusan</th>
  </tr>
</thead>
</table>

<h3>Summary Per Konglomerat</h3>
<table id="summaryKonglomeratTable" class="display" style="width:75%">
<thead>
  <tr>
    <th>No</th>
    <th>Konglomerat</th>
    <th>Rata-rata %Change</th>
    <th>Total Value (Rp)</th>
    <th>Total Δ Value (Rp)</th>
    <th>Total Δ % Value</th>
  </tr>
</thead>
</table>

<h3>Summary Per Sektor</h3>
<table id="summarySectorTable" class="display" style="width:75%">
<thead>
  <tr>
    <th>No</th>
    <th>Sektor</th>
    <th>Rata-rata %Change</th>
    <th>Total Value (Rp)</th>
    <th>Total Δ Value (Rp)</th>
    <th>Total Δ % Value</th>
  </tr>
</thead>
</table>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

<script>
// ================= KONFIG =================
const BASE_STOCKSUMMARY = "https://raw.githubusercontent.com/paulgithubcode/sind/main/stocksummary/";
const BASE_SECTOR = "https://raw.githubusercontent.com/paulgithubcode/sind/main/sector/";

// ================= KONGLOMERAT MAP =================
const konglomeratMap = {
  BREN:"Grup Prajogo Pangestu",TPIA:"Grup Prajogo Pangestu",BRPT:"Grup Prajogo Pangestu",
  CDIA:"Grup Prajogo Pangestu",CUAN:"Grup Prajogo Pangestu",PTRO:"Grup Prajogo Pangestu",
  BRMS:"Grup Bakrie",BUMI:"Grup Bakrie",ENRG:"Grup Bakrie",DEWA:"Grup Bakrie",
  VKTR:"Grup Bakrie",BNBR:"Grup Bakrie",
  MBMA:"Grup Boy Thohir",AADI:"Grup Boy Thohir",EMAS:"Grup Boy Thohir",
  MDKA:"Grup Boy Thohir",ADRO:"Grup Boy Thohir",
  DCII:"Grup Salim",DNET:"Grup Salim",ICBP:"Grup Salim",INDF:"Grup Salim",LSIP:"Grup Salim",
  DSSA:"Grup Sinarmas",SMMA:"Grup Sinarmas",GEMS:"Grup Sinarmas",EXCL:"Grup Sinarmas",SMAR:"Grup Sinarmas",
  PGUN:"Grup Haji Isam",JARR:"Grup Haji Isam",TEBE:"Grup Haji Isam",FAST:"Grup Haji Isam",
  RATU:"Grup Happy Hapsoro",RAJA:"Grup Happy Hapsoro",BUVA:"Grup Happy Hapsoro",
  MINA:"Grup Happy Hapsoro",SINI:"Grup Happy Hapsoro",
  EMTK:"Grup EMTEK",BBHI:"Grup EMTEK",SCMA:"Grup EMTEK",
  BUKA:"Grup EMTEK",SAME:"Grup EMTEK",SUPA:"Grup EMTEK",
  TAPG:"Grup Triputra",DSNG:"Grup Triputra",ESSA:"Grup Triputra",
  DRMA:"Grup Triputra",ASSA:"Grup Triputra",
  MLPT:"Grup Lippo",SILO:"Grup Lippo",LPKR:"Grup Lippo",MLPL:"Grup Lippo",LPPF:"Grup Lippo",
  PANI:"Grup Agung Sedayu (Aguan)",CBDK:"Grup Agung Sedayu (Aguan)",
  ERA:"Grup Agung Sedayu (Aguan)",INPC:"Grup Agung Sedayu (Aguan)",JIHD:"Grup Agung Sedayu (Aguan)",
  HUMI:"Grup Humpuss/Tommy Soeharto",GTSI:"Grup Humpuss/Tommy Soeharto",GOLF:"Grup Humpuss/Tommy Soeharto",
  WIFI:"Hashim Djojohadikusumo",COIN:"Hashim Djojohadikusumo",TRIN:"Hashim Djojohadikusumo",
  IRSX:"Hashim Djojohadikusumo",PADA:"Hashim Djojohadikusumo",INET:"Hashim Djojohadikusumo",
  TRUE:"Hashim Djojohadikusumo",KETR:"Hashim Djojohadikusumo",DOOH:"Hashim Djojohadikusumo",
  CLEO:"Hermanto Tanoko",RISE:"Hermanto Tanoko",CAKK:"Hermanto Tanoko",ZONE:"Hermanto Tanoko",
  DEPO:"Hermanto Tanoko",AVIA:"Hermanto Tanoko",PEVE:"Hermanto Tanoko",BLES:"Hermanto Tanoko",MERI:"Hermanto Tanoko",
};

// ================= SECTOR FILES =================
const sectorFiles = [
  "Healthcare.json",
  "Basic_Material.json",
  "Financials.json",
  "Transportation_&_Logistic.json",
  "Technology.json",
  "Consumer_Non-Cyclicals.json",
  "Industrials.json",
  "Energy.json",
  "Consumer_Cyclicals.json",
  "Infrastructures.json",
  "Properties_&_Real_Estate.json"
];

// ================= UTIL =================
function todayStr(){ return new Date().toISOString().split("T")[0]; }
function apiByDate(date){ return `${BASE_STOCKSUMMARY}GetStockSummary_${date}.json`; }
function prevDateStr(dateStr){
  const d = new Date(dateStr);
  d.setDate(d.getDate()-1);
  return d.toISOString().split("T")[0];
}
async function getPrevTradingData(date){
  let prevDate = prevDateStr(date);

  for(let i = 0; i < 30; i++){ // aman untuk Lebaran panjang
    try{
      const r = await fetch(apiByDate(prevDate));
      if(r.ok){
        console.log("Prev trading date dipakai:", prevDate);
        return await r.json();
      }
    }catch(e){}
    prevDate = prevDateStr(prevDate);
  }

  console.warn("Prev trading day tidak ditemukan");
  return { data: [] };
}


// ================= TABLES =================
let stockTable, summaryKonglomeratTable, summarySectorTable;

// ================= LOAD DATA =================
async function loadData(date){
  try{
    // Fetch stock summary hari ini
    const res = await fetch(apiByDate(date));
    if(!res.ok) throw new Error("Stock summary untuk tanggal ini tidak tersedia");
    const stockJson = await res.json();

	// Fetch stock summary previous trading day (skip libur)
	const prevDataJson = await getPrevTradingData(date);

    // Fetch sektor
    const sectorMap = {};
    for(const file of sectorFiles){
      try{
        const r = await fetch(BASE_SECTOR + file);
        if(!r.ok) continue;
        const j = await r.json();
        j.data.forEach(x=>sectorMap[x.Code] = file.replace(".json",""));
      }catch(e){ console.warn("Gagal load sector", file);}
    }

    // buat map prev value per code
    const prevValueMap = {};
	const prevVolumeMap = {};
	const prevFreqMap = {};
	
	prevDataJson.data.forEach(r=>{
	  prevValueMap[r.StockCode] = r.Value || 0; 
	  prevVolumeMap[r.StockCode] = r.Volume || 0;
	  prevFreqMap[r.StockCode] = r.Frequency || 0;
	});

    // gabungkan data
    const data = stockJson.data.map(r=>{
      const prevValue = prevValueMap[r.StockCode] || 0;
	  const prevVolume = prevVolumeMap[r.StockCode] || 0;
	  const prevFreq = prevFreqMap[r.StockCode] || 0;
	  
      const deltaValue = r.Value - prevValue;
      const deltaValuePct = prevValue > 0 ? (deltaValue / prevValue) * 100 : null;
	  
	  const deltaVolume = r.Volume - prevVolume;
	  const deltaVolumePct = prevVolume > 0
	    ? (deltaVolume / prevVolume) * 100
	    : null;
		
	  const deltaFreq = r.Frequency - prevFreq;
	  const deltaFreqPct = prevFreq > 0
	    ? (deltaFreq / prevFreq) * 100
	    : null;
	  
      const marketCap = r.Close*r.ListedShares;
      const changePct = r.Previous ? ((r.Close - r.Previous)/r.Previous)*100 : 0;

		// ===== LOGIC KEPUTUSAN =====
		let keputusan = "-";

		if (
		  deltaVolume > 0 &&
		  deltaFreq < 0 &&
		  deltaValue > 0 &&
		  changePct > 0
		) {
		  keputusan = "Bagus";
		}


      return {
        code:r.StockCode,
        name:r.StockName,
        kong:konglomeratMap[r.StockCode] || "-",
        sector:sectorMap[r.StockCode] || "-",
        close:r.Close,
        volume:r.Volume,
		deltaVolume,
		deltaVolumePct,
		frequency: r.Frequency,
		deltaFreq,
		deltaFreqPct,
        valueRupiah:r.Value,
        deltaValue,
        deltaValuePct,
        weight:r.WeightForIndex,
        marketCap,
        change:r.Change,
        changePct,
		keputusan
      };
    });

    renderTables(data);
  }catch(e){ alert(e); console.error(e);}
}

// ================= RENDER TABLE =================
function renderTables(data){
  if(stockTable) stockTable.destroy();
  if(summaryKonglomeratTable) summaryKonglomeratTable.destroy();
  if(summarySectorTable) summarySectorTable.destroy();

  // ===== Stock Table =====
	stockTable = $('#stockTable').DataTable({
	  data,
	  paging:false,
	  order:[[18,'desc']], // Change % (index geser karena No)
	  columnDefs:[{
		targets:0,
		orderable:false,
		searchable:false
	  }],
	  columns:[
		{data:null}, // No
		{data:'code'},
		{data:'name'},
		{data:'kong'},
		{data:'sector'},
		{data:'close', className:'dt-right', render: $.fn.dataTable.render.number('.',',',0)},
		{data:'volume', className:'dt-right', render: $.fn.dataTable.render.number('.',',',0)},
		{
		  data:'deltaVolume',
		  className:'dt-right',
		  render:(d,t)=>{
			if(t==='sort'||t==='filter') return d;
			const cls = d > 0 ? 'delta-positive' : d < 0 ? 'delta-negative' : 'delta-zero';
			return `<span class="${cls}">${d.toLocaleString('id-ID')}</span>`;
		  }
		},
		{
		  data:'deltaVolumePct',
		  className:'dt-right',
		  render:(d,t)=>{
			if(t==='sort'||t==='filter') return d ?? -999999;
			if(d===null) return '<span class="delta-zero">-</span>';
			const cls = d > 0 ? 'delta-positive' : d < 0 ? 'delta-negative' : 'delta-zero';
			return `<span class="${cls}">${d.toFixed(2)}%</span>`;
		  }
		},

		{data:'frequency', className:'dt-right', render: $.fn.dataTable.render.number('.',',',0)},
		{
		  data:'deltaFreq',
		  className:'dt-right',
		  render:(d,t)=>{
			if(t==='sort'||t==='filter') return d;
			const cls = d > 0 ? 'delta-positive' : d < 0 ? 'delta-negative' : 'delta-zero';
			return `<span class="${cls}">${d.toLocaleString('id-ID')}</span>`;
		  }
		},
		{
		  data:'deltaFreqPct',
		  className:'dt-right',
		  render:(d,t)=>{
			if(t==='sort'||t==='filter') return d ?? -999999;
			if(d===null) return '<span class="delta-zero">-</span>';
			const cls = d > 0 ? 'delta-positive' : d < 0 ? 'delta-negative' : 'delta-zero';
			return `<span class="${cls}">${d.toFixed(2)}%</span>`;
		  }
		},
		
		{data:'valueRupiah', className:'dt-right', render: $.fn.dataTable.render.number('.',',',0)},
		{
		  data:'deltaValue',
		  className:'dt-right',
		  render:(d,t)=>{
			if(t==='sort'||t==='filter') return d;
			const cls = d > 0 ? 'delta-positive' : d < 0 ? 'delta-negative' : 'delta-zero';
			return `<span class="${cls}">${d.toLocaleString('id-ID')}</span>`;
		  }
		},
		{
		  data:'deltaValuePct',
		  className:'dt-right',
		  render:(d,t)=>{
			if(t==='sort'||t==='filter') return d ?? -999999;
			if(d===null) return '<span class="delta-zero">-</span>';
			const cls = d > 0 ? 'delta-positive' : d < 0 ? 'delta-negative' : 'delta-zero';
			return `<span class="${cls}">${d.toFixed(2)}%</span>`;
		  }
		},
		
		{data:'weight', className:'dt-right'},
		{data:'marketCap', className:'dt-right', render: $.fn.dataTable.render.number('.',',',0)},
		{data:'change', className:'dt-right'},
		{data:'changePct', className:'dt-right', render:d=>d.toFixed(2)+'%'},
		{
		  data:'keputusan',
		  render:(d)=>{
			if(d === "Bagus"){
			  return `<span style="color:green;font-weight:bold">Bagus</span>`;
			}
			return `<span style="color:#999">-</span>`;
		  }
		}		
	  ],
	  drawCallback:function(){
		const api=this.api();
		api.column(0,{order:'applied'}).nodes().each((cell,i)=>{
		  cell.innerHTML=i+1;
		});
	  }
	});

	// ===== Summary Konglomerat =====
	const sumK = {};
	data.forEach(r=>{
	  if(r.kong!=="-"){
		if(!sumK[r.kong]) sumK[r.kong]={
		weightedChange:0,
		totalValue:0,
		totalDelta:0,
		prevTotalValue:0,
		count:0};
		sumK[r.kong].weightedChange += r.changePct * r.valueRupiah;
		sumK[r.kong].totalValue += r.valueRupiah;
		sumK[r.kong].totalDelta += r.deltaValue;
		sumK[r.kong].prevTotalValue += r.valueRupiah - r.deltaValue; // nilai hari sebelumnya
		sumK[r.kong].count++;
	  }
	});
	summaryKonglomeratTable = $('#summaryKonglomeratTable').DataTable({
	  data:Object.keys(sumK).map(k=>{
		const totaldeltaValuePct = sumK[k].prevTotalValue
		  ? (sumK[k].totalDelta / sumK[k].prevTotalValue) * 100
		  : 0;
		return {
		  kong:k,
		avgChange: sumK[k].totalValue
		  ? sumK[k].weightedChange / sumK[k].totalValue
		  : 0,
		  totalValue:sumK[k].totalValue,
		  totalDelta:sumK[k].totalDelta,
		  totaldeltaValuePct
		};
	  }),
	  paging:false,
	  searching:false,
	  order:[[2,'desc']],
	  columnDefs:[{
		targets:0,
		orderable:false,
		searchable:false
	  }],
	  columns:[
		{data:null},
		{data:'kong'},
		{data:'avgChange', className:'dt-right', render:d=>d.toFixed(2)+'%'},
		{data:'totalValue', className:'dt-right', render: $.fn.dataTable.render.number('.',',',0)},
		{data:'totalDelta', className:'dt-right', render:d=>{
		  const cls=d>0?'delta-positive':d<0?'delta-negative':'delta-zero';
		  return `<span class="${cls}">${d.toLocaleString('id-ID')}</span>`;
		}},
		{data:'totaldeltaValuePct', className:'dt-right', render:d=>{
		  const cls=d>0?'delta-positive':d<0?'delta-negative':'delta-zero';
		  return `<span class="${cls}">${d.toFixed(2)}%</span>`;
		}}
	  ],
	  drawCallback:function(){
		const api=this.api();
		api.column(0,{order:'applied'}).nodes().each((cell,i)=>{
		  cell.innerHTML=i+1;
		});
	  }
	});

	// ===== Summary Sektor =====
	const sumS = {};
	data.forEach(r=>{
	  const s = r.sector;
	  if(!sumS[s]) sumS[s]={
		weightedChange:0,
		totalValue:0,
		totalDelta:0,
		prevTotalValue:0
	  };

	  sumS[s].weightedChange += r.changePct * r.valueRupiah;
	  sumS[s].totalValue += r.valueRupiah;
	  sumS[s].totalDelta += r.deltaValue;
	  sumS[s].prevTotalValue += r.valueRupiah - r.deltaValue;
	});	
	
	summarySectorTable = $('#summarySectorTable').DataTable({
	  data:Object.keys(sumS).map(s=>{
		const totaldeltaValuePct = sumS[s].prevTotalValue
		  ? (sumS[s].totalDelta / sumS[s].prevTotalValue) * 100
		  : 0;
		return {
		  sector:s,
			avgChange: sumS[s].totalValue
			  ? sumS[s].weightedChange / sumS[s].totalValue
			  : 0,
		  totalValue:sumS[s].totalValue,
		  totalDelta:sumS[s].totalDelta,
		  totaldeltaValuePct
		};
	  }),
	  paging:false,
	  searching:false,
	  order:[[2,'desc']],
	  columnDefs:[{
		targets:0,
		orderable:false,
		searchable:false
	  }],
	  columns:[
		{data:null},
		{data:'sector'},
		{data:'avgChange', className:'dt-right', render:d=>d.toFixed(2)+'%'},
		{data:'totalValue', className:'dt-right', render: $.fn.dataTable.render.number('.',',',0)},
		{data:'totalDelta', className:'dt-right', render:d=>{
		  const cls=d>0?'delta-positive':d<0?'delta-negative':'delta-zero';
		  return `<span class="${cls}">${d.toLocaleString('id-ID')}</span>`;
		}},
		{data:'totaldeltaValuePct', className:'dt-right', render:d=>{
		  const cls=d>0?'delta-positive':d<0?'delta-negative':'delta-zero';
		  return `<span class="${cls}">${d.toFixed(2)}%</span>`;
		}}
	  ],
	  drawCallback:function(){
		const api=this.api();
		api.column(0,{order:'applied'}).nodes().each((cell,i)=>{
		  cell.innerHTML=i+1;
		});
	  }
	});

}

// ================= INIT =================
const datePicker = document.getElementById("datePicker");
datePicker.value = todayStr();
datePicker.addEventListener("change", ()=>loadData(datePicker.value));
loadData(datePicker.value);
</script>

</body>
</html>
